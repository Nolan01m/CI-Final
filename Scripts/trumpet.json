{"AWSTemplateFormatVersion":"2010-09-09","Description":"Template for AWS data ingest into Splunk using AWS Kinesis Firehose and AWS Lambda.","Mappings":{"BucketMap":{"us-east-1":{"BucketName":"nhlabs-trumpet-splunk-prod-us-east-1"}}},"Parameters":{"SplunkUsername":{"Description":"The Splunk user that will be used by the template to configure HEC for Trumpet. This user should have permission to list and create HEC tokens.","Type":"String"},"SplunkPassword":{"Description":"The Splunk password for the provided user.","Type":"String","NoEcho":true}},"Metadata":{"AWS::CloudFormation::Interface":{"ParameterGroups":[{"Label":{"default":"Splunk credentials"},"Parameters":["SplunkUsername","SplunkPassword"]}],"ParameterLabels":{"SplunkUsername":{"default":"Splunk username"},"SplunkPassword":{"default":"Splunk password"}}}},"Resources":{"LambdaHecAutomation":{"Type":"AWS::Lambda::Function","Properties":{"Code":{"S3Bucket":{"Fn::FindInMap":["BucketMap",{"Ref":"AWS::Region"},"BucketName"]},"S3Key":"hec_auto_v0.3.zip"},"Handler":"index.handler","Role":{"Fn::GetAtt":["LambdaHecAutomationExecutionRole","Arn"]},"Runtime":"python3.7","Timeout":"30"}},"LambdaHecAutomationExecutionRole":{"Type":"AWS::IAM::Role","Properties":{"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":{"Service":["lambda.amazonaws.com"]},"Action":["sts:AssumeRole"]}]},"Path":"/","Policies":[{"PolicyName":"root","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],"Resource":"arn:aws:logs:*:*:*"}]}}]}},"CustomResourceHecAutomation":{"Type":"Custom::CustomResource","Properties":{"ServiceToken":{"Fn::GetAtt":["LambdaHecAutomation","Arn"]},"SplunkUser":{"Ref":"SplunkUsername"},"SplunkPassword":{"Ref":"SplunkPassword"},"SplunkHttpEventCollectorManagementURL":"https://splunk.nhlabs.org:8089","AWSRegion":{"Ref":"AWS::Region"}}},"CloudTrailEventRule":{"Type":"AWS::Events::Rule","Properties":{"EventPattern":{"detail-type":["AWS API Call via CloudTrail","AWS Console Sign In via CloudTrail"]},"State":"ENABLED","Targets":[{"RoleArn":{"Fn::GetAtt":["CWEFirehoseDeliveryRole","Arn"]},"Id":"splunk_cloudtrail_firehose_target","Arn":{"Fn::GetAtt":["CWEFirehoseDeliveryStream","Arn"]}}]}},"ConfigNotificationEventRule":{"Type":"AWS::Events::Rule","Properties":{"EventPattern":{"source":["aws.config"],"detail-type":["Config Configuration Item Change"]},"State":"ENABLED","Targets":[{"RoleArn":{"Fn::GetAtt":["CWEFirehoseDeliveryRole","Arn"]},"Id":"splunk_config_notification_firehose_target","Arn":{"Fn::GetAtt":["CWEFirehoseDeliveryStream","Arn"]}}]}},"CWEFirehoseProcessor":{"Type":"AWS::Lambda::Function","Properties":{"Code":{"S3Bucket":{"Fn::FindInMap":["BucketMap",{"Ref":"AWS::Region"},"BucketName"]},"S3Key":"splunk_cwe_firehose_processor_v0.3.zip"},"Description":"Stream events from CloudWatch Events to Splunk using HTTP event collector","MemorySize":512,"Handler":"lambda_function.handler","Role":{"Fn::GetAtt":["CWEFirehoseProcessorRole","Arn"]},"Timeout":300,"Runtime":"python3.7"}},"CWEFirehoseDeliveryStream":{"Type":"AWS::KinesisFirehose::DeliveryStream","Properties":{"SplunkDestinationConfiguration":{"S3Configuration":{"CompressionFormat":"UNCOMPRESSED","BucketARN":{"Fn::GetAtt":["CWEBackupS3Bucket","Arn"]},"RoleARN":{"Fn::GetAtt":["CWEBackupS3Role","Arn"]},"BufferingHints":{"IntervalInSeconds":300,"SizeInMBs":1}},"HECEndpointType":"Event","HECToken":{"Fn::GetAtt":["CustomResourceHecAutomation","IndexerAckHECToken"]},"HECAcknowledgmentTimeoutInSeconds":180,"RetryOptions":{"DurationInSeconds":300},"HECEndpoint":"https://splunk.nhlabs.org:8088","S3BackupMode":"FailedEventsOnly","ProcessingConfiguration":{"Enabled":true,"Processors":[{"Parameters":[{"ParameterName":"LambdaArn","ParameterValue":{"Fn::GetAtt":["CWEFirehoseProcessor","Arn"]}},{"ParameterName":"RoleArn","ParameterValue":{"Fn::GetAtt":["CWEBackupS3Role","Arn"]}}],"Type":"Lambda"}]}},"DeliveryStreamType":"DirectPut"}},"CWEFirehoseDeliveryRole":{"Type":"AWS::IAM::Role","Properties":{"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":"sts:AssumeRole","Sid":"","Effect":"Allow","Principal":{"Service":"events.amazonaws.com"}}]}}},"CWEFirehoseDeliveryPolicy":{"Type":"AWS::IAM::Policy","Properties":{"PolicyName":"firehose_delivery_policy","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":["firehose:PutRecord","firehose:PutRecordBatch"],"Resource":[{"Fn::GetAtt":["CWEFirehoseDeliveryStream","Arn"]}],"Effect":"Allow"}]},"Roles":[{"Ref":"CWEFirehoseDeliveryRole"}]}},"CWEBackupS3Bucket":{"Type":"AWS::S3::Bucket","Properties":{"VersioningConfiguration":{"Status":"Enabled"}}},"CWEBackupS3Role":{"Type":"AWS::IAM::Role","Properties":{"Path":"/","Policies":[{"PolicyName":"CWEBackupS3Role","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Sid":"","Effect":"Allow","Action":["glue:GetTableVersions"],"Resource":"*"},{"Sid":"","Effect":"Allow","Action":["s3:AbortMultipartUpload","s3:GetBucketLocation","s3:GetObject","s3:ListBucket","s3:ListBucketMultipartUploads","s3:PutObject"],"Resource":"*"},{"Sid":"","Effect":"Allow","Action":["lambda:InvokeFunction","lambda:GetFunctionConfiguration"],"Resource":"*"},{"Sid":"","Effect":"Allow","Action":["logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],"Resource":"*"},{"Sid":"","Effect":"Allow","Action":["kinesis:DescribeStream","kinesis:GetShardIterator","kinesis:GetRecords"],"Resource":"*"},{"Sid":"","Effect":"Allow","Action":["kms:Decrypt"],"Resource":"*","Condition":{"StringEquals":{"kms:ViaService":{"Fn::Join":["",["kinesis.",{"Ref":"AWS::Region"},".amazonaws.com"]]}},"StringLike":{"kms:EncryptionContext:aws:kinesis:arn":{"Fn::Join":["",["arn:aws:kinesis:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":stream/%FIREHOSE_STREAM_NAME%"]]}}}}]}}],"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":"sts:AssumeRole","Sid":"","Effect":"Allow","Principal":{"Service":"firehose.amazonaws.com"}}]}}},"CWEFirehoseProcessorRole":{"Type":"AWS::IAM::Role","Properties":{"Path":"/","ManagedPolicyArns":["arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"],"Policies":[{"PolicyName":"CWEFirehoseProcessorPolicy","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["lambda:InvokeFunction"],"Resource":["*"]},{"Effect":"Allow","Action":["kinesis:GetRecords","kinesis:GetShardIterator","kinesis:DescribeStream","kinesis:ListStreams","logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],"Resource":"*"}]}}],"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":["sts:AssumeRole"],"Effect":"Allow","Principal":{"Service":["lambda.amazonaws.com"]}}]}}},"CWLFirehoseProcessor":{"Type":"AWS::Lambda::Function","Properties":{"Code":{"S3Bucket":{"Fn::FindInMap":["BucketMap",{"Ref":"AWS::Region"},"BucketName"]},"S3Key":"splunk_cwl_firehose_processor_v0.3.zip"},"Description":"Stream events from CloudWatch Logs to Splunk using HTTP event collector","MemorySize":512,"Handler":"lambda_function.handler","Role":{"Fn::GetAtt":["CWLFirehoseProcessorRole","Arn"]},"Timeout":300,"Runtime":"python3.7"}},"CWLtoKinesisFirehoseRole":{"Type":"AWS::IAM::Role","Properties":{"Policies":[{"PolicyName":"CWLtoKinesisFirehosePolicy","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["firehose:*"],"Resource":["arn:aws:firehose:*:*:*"]},{"Effect":"Allow","Action":["iam:PassRole"],"Resource":["arn:aws:iam::*:role/CWLtoKinesisFirehoseRole"]}]}}],"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":{"Fn::Join":["",["logs.",{"Ref":"AWS::Region"},".amazonaws.com"]]}}}}}},"CWLFirehoseDeliveryStream":{"Type":"AWS::KinesisFirehose::DeliveryStream","Properties":{"SplunkDestinationConfiguration":{"S3Configuration":{"CompressionFormat":"UNCOMPRESSED","BucketARN":{"Fn::GetAtt":["CWLBackupS3Bucket","Arn"]},"RoleARN":{"Fn::GetAtt":["CWLBackupS3Role","Arn"]},"BufferingHints":{"IntervalInSeconds":300,"SizeInMBs":1}},"HECEndpointType":"Event","HECToken":{"Fn::GetAtt":["CustomResourceHecAutomation","IndexerAckHECToken"]},"HECAcknowledgmentTimeoutInSeconds":180,"RetryOptions":{"DurationInSeconds":300},"HECEndpoint":"https://splunk.nhlabs.org:8088","S3BackupMode":"FailedEventsOnly","ProcessingConfiguration":{"Enabled":true,"Processors":[{"Parameters":[{"ParameterName":"LambdaArn","ParameterValue":{"Fn::GetAtt":["CWLFirehoseProcessor","Arn"]}},{"ParameterName":"RoleArn","ParameterValue":{"Fn::GetAtt":["CWLBackupS3Role","Arn"]}}],"Type":"Lambda"}]}},"DeliveryStreamType":"DirectPut"}},"CWLFirehoseDeliveryRole":{"Type":"AWS::IAM::Role","Properties":{"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":"sts:AssumeRole","Sid":"","Effect":"Allow","Principal":{"Service":"events.amazonaws.com"}}]}}},"CWLFirehoseDeliveryPolicy":{"Type":"AWS::IAM::Policy","Properties":{"PolicyName":"firehose_delivery_policy","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":["firehose:PutRecord","firehose:PutRecordBatch"],"Resource":[{"Fn::GetAtt":["CWLFirehoseDeliveryStream","Arn"]}],"Effect":"Allow"}]},"Roles":[{"Ref":"CWLFirehoseDeliveryRole"}]}},"CWLBackupS3Bucket":{"Type":"AWS::S3::Bucket","Properties":{"VersioningConfiguration":{"Status":"Enabled"}}},"CWLBackupS3Role":{"Type":"AWS::IAM::Role","Properties":{"Path":"/","Policies":[{"PolicyName":"CWLBackupS3Role","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Sid":"","Effect":"Allow","Action":["glue:GetTableVersions"],"Resource":"*"},{"Sid":"","Effect":"Allow","Action":["s3:AbortMultipartUpload","s3:GetBucketLocation","s3:GetObject","s3:ListBucket","s3:ListBucketMultipartUploads","s3:PutObject"],"Resource":"*"},{"Sid":"","Effect":"Allow","Action":["lambda:InvokeFunction","lambda:GetFunctionConfiguration"],"Resource":"*"},{"Sid":"","Effect":"Allow","Action":["logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],"Resource":"*"},{"Sid":"","Effect":"Allow","Action":["kinesis:DescribeStream","kinesis:GetShardIterator","kinesis:GetRecords"],"Resource":"*"},{"Sid":"","Effect":"Allow","Action":["kms:Decrypt"],"Resource":{"Fn::Join":["",["arn:aws:kms:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":key/%SSE_KEY_ARN%"]]},"Condition":{"StringEquals":{"kms:ViaService":{"Fn::Join":["",["kinesis.",{"Ref":"AWS::Region"},".amazonaws.com"]]}},"StringLike":{"kms:EncryptionContext:aws:kinesis:arn":{"Fn::Join":["",["arn:aws:kinesis:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":stream/%FIREHOSE_STREAM_NAME%"]]}}}}]}}],"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":"sts:AssumeRole","Sid":"","Effect":"Allow","Principal":{"Service":"firehose.amazonaws.com"}}]}}},"CWLFirehoseProcessorRole":{"Type":"AWS::IAM::Role","Properties":{"Path":"/","ManagedPolicyArns":["arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"],"Policies":[{"PolicyName":"CWLFirehoseProcessorPolicy","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":"logs:CreateLogGroup","Resource":"arn:aws:logs:*:*:*"},{"Effect":"Allow","Action":["logs:CreateLogStream","logs:PutLogEvents"],"Resource":["arn:aws:logs:*:*:*:*:*"]}]}}],"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":["sts:AssumeRole"],"Effect":"Allow","Principal":{"Service":["lambda.amazonaws.com"]}}]}}},"VPCtoKinesisFirehoseRole":{"Type":"AWS::IAM::Role","Properties":{"Policies":[{"PolicyName":"VPCtoKinesisFirehosePolicy","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["firehose:*"],"Resource":["arn:aws:firehose:*:*:*"]},{"Effect":"Allow","Action":["iam:PassRole"],"Resource":["arn:aws:iam::*:role/VPCtoKinesisFirehoseRole"]}]}}],"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":{"Fn::Join":["",["logs.",{"Ref":"AWS::Region"},".amazonaws.com"]]}}}}}},"VPCFirehoseDeliveryStream":{"Type":"AWS::KinesisFirehose::DeliveryStream","Properties":{"SplunkDestinationConfiguration":{"S3Configuration":{"CompressionFormat":"UNCOMPRESSED","BucketARN":{"Fn::GetAtt":["VPCBackupS3Bucket","Arn"]},"RoleARN":{"Fn::GetAtt":["VPCBackupS3Role","Arn"]},"BufferingHints":{"IntervalInSeconds":300,"SizeInMBs":1}},"HECEndpointType":"Event","HECToken":{"Fn::GetAtt":["CustomResourceHecAutomation","IndexerAckHECToken"]},"HECAcknowledgmentTimeoutInSeconds":180,"RetryOptions":{"DurationInSeconds":300},"HECEndpoint":"https://splunk.nhlabs.org:8088","S3BackupMode":"FailedEventsOnly","ProcessingConfiguration":{"Enabled":true,"Processors":[{"Parameters":[{"ParameterName":"LambdaArn","ParameterValue":{"Fn::GetAtt":["VPCFirehoseProcessor","Arn"]}},{"ParameterName":"RoleArn","ParameterValue":{"Fn::GetAtt":["VPCBackupS3Role","Arn"]}}],"Type":"Lambda"}]}},"DeliveryStreamType":"DirectPut"}},"VPCFirehoseDeliveryRole":{"Type":"AWS::IAM::Role","Properties":{"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":"sts:AssumeRole","Sid":"","Effect":"Allow","Principal":{"Service":"events.amazonaws.com"}}]}}},"VPCFirehoseDeliveryPolicy":{"Type":"AWS::IAM::Policy","Properties":{"PolicyName":"firehose_delivery_policy","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":["firehose:PutRecord","firehose:PutRecordBatch"],"Resource":[{"Fn::GetAtt":["VPCFirehoseDeliveryStream","Arn"]}],"Effect":"Allow"}]},"Roles":[{"Ref":"VPCFirehoseDeliveryRole"}]}},"VPCBackupS3Bucket":{"Type":"AWS::S3::Bucket","Properties":{"VersioningConfiguration":{"Status":"Enabled"}}},"VPCBackupS3Role":{"Type":"AWS::IAM::Role","Properties":{"Path":"/","Policies":[{"PolicyName":"VPCBackupS3Role","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":["s3:AbortMultipartUpload","s3:GetBucketLocation","s3:GetObject","s3:ListBucket","s3:ListBucketMultipartUploads","s3:PutObject"],"Resource":"*","Effect":"Allow"},{"Effect":"Allow","Action":["lambda:InvokeFunction","lambda:GetFunctionConfiguration"],"Resource":"*"},{"Action":["logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],"Resource":"*","Effect":"Allow"}]}}],"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":"sts:AssumeRole","Sid":"","Effect":"Allow","Principal":{"Service":"firehose.amazonaws.com"}}]}}},"VPCFirehoseProcessorRole":{"Type":"AWS::IAM::Role","Properties":{"Path":"/","ManagedPolicyArns":["arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"],"Policies":[{"PolicyName":"VPCFirehoseProcessorPolicy","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":"logs:CreateLogGroup","Resource":"arn:aws:logs:*:*:*"},{"Effect":"Allow","Action":["logs:CreateLogStream","logs:PutLogEvents"],"Resource":["arn:aws:logs:*:*:*:*:*"]}]}}],"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":["sts:AssumeRole"],"Effect":"Allow","Principal":{"Service":["lambda.amazonaws.com"]}}]}}},"VPCFirehoseProcessor":{"Type":"AWS::Lambda::Function","Properties":{"Code":{"S3Bucket":{"Fn::FindInMap":["BucketMap",{"Ref":"AWS::Region"},"BucketName"]},"S3Key":"splunk_vpc_firehose_processor_v0.3.zip"},"Description":"Stream events from VPC Flow Logs to Splunk using HTTP event collector","MemorySize":512,"Handler":"lambda_function.handler","Role":{"Fn::GetAtt":["VPCFirehoseProcessorRole","Arn"]},"Timeout":300,"Runtime":"python3.7"}},"VPCFlowLogSubscriptionFiltervpcflowlogs":{"Type":"AWS::Logs::SubscriptionFilter","Properties":{"RoleArn":{"Fn::GetAtt":["VPCtoKinesisFirehoseRole","Arn"]},"LogGroupName":"vpc_flow_logs","FilterPattern":"","DestinationArn":{"Fn::GetAtt":["VPCFirehoseDeliveryStream","Arn"]}}},"CWLFlowLogSubscriptionFiltercloudwatchlogs":{"Type":"AWS::Logs::SubscriptionFilter","Properties":{"RoleArn":{"Fn::GetAtt":["CWLtoKinesisFirehoseRole","Arn"]},"LogGroupName":"cloudwatch_logs","FilterPattern":"","DestinationArn":{"Fn::GetAtt":["CWLFirehoseDeliveryStream","Arn"]}}},"CWEFindingEventRuleawsec2":{"Type":"AWS::Events::Rule","Properties":{"EventPattern":{"source":["aws.ec2"],"detail-type":["EC2 Instance State-change Notification","EBS Volume Notification","EBS Snapshot Notification","EC2 Spot Instance Interruption Warning"]},"State":"ENABLED","Targets":[{"RoleArn":{"Fn::GetAtt":["CWEFirehoseDeliveryRole","Arn"]},"Id":"splunk_cwe_firehose_target","Arn":{"Fn::GetAtt":["CWEFirehoseDeliveryStream","Arn"]}}]}}}}